<!DOCTYPE html>
<html
  lang="en"
  itemscope
  itemtype="http://schema.org/WebPage"
>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>
          k8s学习笔记-黑马 - Big Wilte Cat&#39;s Home
        </title>
    

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="大白猫" />
  <meta name="description" content="为了准备CKA看了b站上黑马程序员的k8s课程，总体来说比较基础，也有一些过时的内容，但优点在于简单、全面、清晰。参考评论区的笔记记录一下。" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.116.1" />


<link rel="canonical" href="https://zyt153.github.io/post/note_k8s_heima/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.d8d87b982993a745e5e7b6a6cbf257be8c3e82aab5e485f0908ad7e6c3501ab2.css" integrity="sha256-2Nh7mCmTp0Xl57amy/JXvow&#43;gqq15IXwkIrX5sNQGrI=" media="screen" crossorigin="anonymous">







<meta property="og:title" content="k8s学习笔记-黑马" />
<meta property="og:description" content="为了准备CKA看了b站上黑马程序员的k8s课程，总体来说比较基础，也有一些过时的内容，但优点在于简单、全面、清晰。参考评论区的笔记记录一下。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zyt153.github.io/post/note_k8s_heima/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2024-01-22T13:03:01+08:00" />
<meta property="article:modified_time" content="2024-01-22T13:03:01+08:00" />
<meta itemprop="name" content="k8s学习笔记-黑马">
<meta itemprop="description" content="为了准备CKA看了b站上黑马程序员的k8s课程，总体来说比较基础，也有一些过时的内容，但优点在于简单、全面、清晰。参考评论区的笔记记录一下。"><meta itemprop="datePublished" content="2024-01-22T13:03:01+08:00" />
<meta itemprop="dateModified" content="2024-01-22T13:03:01+08:00" />
<meta itemprop="wordCount" content="16596">
<meta itemprop="keywords" content="k8s,cka,study," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="k8s学习笔记-黑马"/>
<meta name="twitter:description" content="为了准备CKA看了b站上黑马程序员的k8s课程，总体来说比较基础，也有一些过时的内容，但优点在于简单、全面、清晰。参考评论区的笔记记录一下。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




  </head>
  <body>
    <div id="back-to-top"></div>

    <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Hey!</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://zyt153.github.io/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://zyt153.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://zyt153.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://zyt153.github.io/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://zyt153.github.io/about/">About</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://zyt153.github.io/">Find More</a>
          
        
      </li>
    

    
  </ul>
</nav>


    
      






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

    

    

    


    <header id="header" class="header">
      <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Hey!
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://zyt153.github.io/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://zyt153.github.io/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://zyt153.github.io/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://zyt153.github.io/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://zyt153.github.io/about/">About</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://zyt153.github.io/">Find More</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

    </header>

    <div id="mobile-panel">
      <main id="main" class="main bg-llight wallpaper">
        <div class="content-wrapper">
    <div id="content" class="content">
      <article class="post">
        
        <header class="post-header">
          <h1 class="post-title">k8s学习笔记-黑马</h1>
          

          <div class="post-meta">
  <div class="post-meta-author">
    by
      <a href="/about">
        <span class="post-meta-author-name">
          大白猫
        </span>
      </a>
    
  </div>

  <div class="post-meta-time">
    <time datetime="2024-01-22">
      2024-01-22
    </time>
  </div>

  


  <div class="post-meta__right">
    <span class="post-meta-more">
        16596 words -
        34 min read
      </span>

    <div class="post-meta-category">
        <a href="https://zyt153.github.io/categories/k8s/"> k8s </a>
          
      </div>


    
    


    
    
  </div>
</div>

        </header>

        
        <div class="post-content">
          <p>为了准备CKA看了b站上<a href="https://www.bilibili.com/video/BV1Qv41167ck/">黑马程序员的k8s课程</a>，总体来说比较基础，也有一些过时的内容，但优点在于简单、全面、清晰。参考<a href="https://www.yuque.com/fairy-era/yg511q/zm4xzp#y7A5u">评论区的笔记</a>记录一下。</p>
<h2 id="1-k8s介绍">1 k8s介绍</h2>
<h3 id="k8s组件">k8s组件</h3>
<p>kubernetes 集群主要由控制节点（master） 和 工作节点（node）构成，每个节点上有不同的组件。</p>
<ul>
<li>
<p><strong>控制节点（master）</strong>：集群的控制平面，负责集群的决策。</p>
<ul>
<li>
<p>API Server：集群操作的唯一入口，接收用户输入的命令，提供认证、授权、API注册和发现等机制。</p>
</li>
<li>
<p>Scheduler：负责集群资源调度，按照预定的调度策略将 Pod 调度到相应的 node 节点上。</p>
</li>
<li>
<p>ControllerManager：负责维护集群的状态，比如程序部署安排、故障检测、自动扩展和滚动更新等。</p>
</li>
<li>
<p>Etcd：负责存储集群中各种资源对象的信息。</p>
</li>
</ul>
</li>
<li>
<p><strong>工作节点（node）</strong>：集群的数据平面，负责为容器提供运行环境。</p>
<ul>
<li>
<p>Kubelet：负责维护容器的生命周期，即通过控制 Docker ，来创建、更新、销毁容器。</p>
</li>
<li>
<p>KubeProxy：负责提供集群内部的服务发现和负载均衡。</p>
</li>
<li>
<p>Docker：负责节点上容器的各种操作。</p>
</li>
</ul>
</li>
</ul>

<link rel="stylesheet" href="/css/hugo-easy-gallery.css" />
<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:100%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-1.png" />
    </div>
    <a href="/image/heima-note-1.png" itemprop="contentUrl"></a>
  </figure>
</div>

<h3 id="相关概念">相关概念</h3>
<ul>
<li>
<p><strong>Master</strong>：集群控制节点，每个集群至少有一个 Master 节点。</p>
</li>
<li>
<p><strong>Node</strong>：工作负载节点，Master 分配容器到 Node上，Node 上的 Docker 负责容器的运行。</p>
</li>
<li>
<p><strong>Pod</strong>：Kubernetes 的最小控制单元，容器运行在 Pod 中，一个 Pod 中可以有一个或多个容器。</p>
</li>
<li>
<p><strong>Controller</strong>：控制器，通过它来实现对 Pod 的管理，比如启动 Pod 、停止 Pod 、伸缩 Pod 的数量等。</p>
</li>
<li>
<p><strong>Service</strong>：Pod 对外服务的统一入口，可以维护同一类的多个 Pod 。</p>
</li>
<li>
<p><strong>Label</strong>：标签，用于对 Pod 进行分类。</p>
</li>
<li>
<p><strong>NameSpace</strong>：命名空间，用来隔离 Pod 的运行环境。</p>
</li>
</ul>
<h2 id="2-集群搭建">2 集群搭建</h2>
<p>&hellip;</p>
<h2 id="3-资源管理">3 资源管理</h2>
<h3 id="资源管理介绍">资源管理介绍</h3>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:100%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-2.png" />
    </div>
    <a href="/image/heima-note-2.png" itemprop="contentUrl"></a>
  </figure>
</div>

<h3 id="yaml介绍">yaml介绍</h3>
<ul>
<li>数组用<code>-</code></li>
<li>多个yaml用<code>---</code>分割</li>
</ul>
<h3 id="资源管理方式">资源管理方式</h3>
<ul>
<li>
<p><strong>命令式对象管理</strong>：直接使用命令去操作kubernetes的资源</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl <span style="color:#f92672">[</span>command<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>name<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>flags<span style="color:#f92672">]</span>
</span></span></code></pre></div><ul>
<li>
<p><strong>command</strong>：指定要对资源执行的操作，比如create、get、delete。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl --help
</span></span></code></pre></div></li>
<li>
<p><strong>type</strong>：指定资源的类型，比如deployment、pod、service。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl api-resources
</span></span></code></pre></div></li>
<li>
<p><strong>name</strong>：指定资源的名称，名称大小写敏感。</p>
</li>
<li>
<p><strong>flags</strong>：指定额外的可选参数 （例如<code>-o wide</code>，<code>-o yaml</code>）。</p>
</li>
</ul>
</li>
<li>
<p><strong>命令式对象配置</strong>：通过命令配置和配置文件去操作kubernetes的资源</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create/patch/delete -f nginx-pod.yaml
</span></span></code></pre></div></li>
<li>
<p><strong>声明式对象配置</strong>：通过apply命令和配置文件去操作kubernetes的资源 (相当于create和patch)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f nginx-pod.yaml
</span></span></code></pre></div></li>
</ul>
<h2 id="4-实战入门">4 实战入门</h2>
<h3 id="namespace">namespace</h3>
<p>Namespace的主要作用：实现<strong>多套系统的资源隔离</strong>或者<strong>多租户的资源隔离</strong>。</p>
<p>Kubernetes在集群启动之后，会默认创建几个namespace：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt;&gt; kc get ns
</span></span><span style="display:flex;"><span>NAME                 STATUS   AGE
</span></span><span style="display:flex;"><span>default              Active   19d   <span style="color:#75715e"># 未指定ns的对象会被分配在default命名空间</span>
</span></span><span style="display:flex;"><span>kube-node-lease      Active   19d   <span style="color:#75715e"># 集群节点之间的心跳维护，v1.13开始引入</span>
</span></span><span style="display:flex;"><span>kube-public          Active   19d   <span style="color:#75715e"># 此命名空间的资源可以被所有人访问（包括未认证用户）</span>
</span></span><span style="display:flex;"><span>kube-system          Active   19d   <span style="color:#75715e"># 包含kubernetes系统创建的资源</span>
</span></span></code></pre></div><h3 id="pod">pod</h3>
<ul>
<li>
<p>Pod是kubernetes集群管理的最小单元，程序要运行必须部署在容器中，而容器必须存在于Pod中。</p>
</li>
<li>
<p>Pod可以认为是容器的封装，一个Pod中可以存在一个或多个容器。</p>
</li>
</ul>
<h3 id="label">label</h3>
<p>Label以<strong>key/value</strong>键值对的形式附加到各种对象上，如Node、Pod、Service等。可以通过Label实现资源的多维度分组，进行资源分配、调度、配置和部署等管理工作。</p>
<p>两种Label Selector：</p>
<p>(1) 基于等式的Label Selector：</p>
<ul>
<li>name=slave：选择所有包含Label中的key=“name”并且value=“slave”的对象。</li>
<li>env!=production：选择所有包含Label中的key=“env”并且value!=“production”的对象。</li>
</ul>
<p>(2) 基于集合的Label Selector。</p>
<ul>
<li>name in (master,slave)：选择所有包含Label中的key=“name”并且value=“master”或value=“slave”的对象。</li>
<li>name not in (master,slave)：选择所有包含Label中的key=“name”并且value!=“master”和value!=“slave”的对象。</li>
</ul>
<p>命令行：</p>
<ul>
<li>
<p>添加label：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl label pod xxx key<span style="color:#f92672">=</span>value <span style="color:#f92672">[</span>-n ns<span style="color:#f92672">]</span>
</span></span></code></pre></div></li>
<li>
<p>查看label:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get pod xxx <span style="color:#f92672">[</span>-n ns<span style="color:#f92672">]</span> --show-labels
</span></span></code></pre></div></li>
<li>
<p>筛选标签：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get pod -l key<span style="color:#f92672">=</span>value <span style="color:#f92672">[</span>-n ns<span style="color:#f92672">]</span> --show-labels
</span></span></code></pre></div></li>
<li>
<p>删除标签：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl label pod xxx key- <span style="color:#f92672">[</span>-n ns<span style="color:#f92672">]</span>
</span></span></code></pre></div></li>
</ul>
<h3 id="deployment">deployment</h3>
<p>deployment是一种pod控制器</p>
<p>命令行：</p>
<ul>
<li>
<p>创建deployment：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create deploy xxx <span style="color:#f92672">[</span>-n ns<span style="color:#f92672">]</span>
</span></span></code></pre></div></li>
<li>
<p>指定replica：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl scale deploy xxx <span style="color:#f92672">[</span>--replicas<span style="color:#f92672">=</span>3<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>-n ns<span style="color:#f92672">]</span>
</span></span></code></pre></div></li>
<li>
<p>删除：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl delete deployment xxx <span style="color:#f92672">[</span>-n ns<span style="color:#f92672">]</span>
</span></span></code></pre></div></li>
</ul>
<h3 id="service">service</h3>
<p>Service是一组同类的Pod对外的访问接口。借助Service，应用可以实现服务发现和负载均衡。</p>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:100%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-3.png" />
    </div>
    <a href="/image/heima-note-3.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>命令行：</p>
<ul>
<li>
<p>创建cluster内部可访问的service：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 暴露service</span>
</span></span><span style="display:flex;"><span>kubectl expose deploy nginx --name<span style="color:#f92672">=</span>svc-nginx1 --type<span style="color:#f92672">=</span>ClusterIP --port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> --target-port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> -n ns
</span></span></code></pre></div></li>
<li>
<p>创建cluster外部可访问的service：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 暴露service</span>
</span></span><span style="display:flex;"><span>kubectl expose deploy nginx --name<span style="color:#f92672">=</span>svc-nginx2 --type<span style="color:#f92672">=</span>NodePort --port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> --target-port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> -n ns
</span></span></code></pre></div></li>
<li>
<p>对比这两者：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt;&gt; kc get service
</span></span><span style="display:flex;"><span>NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE
</span></span><span style="display:flex;"><span>nginx        NodePort    10.96.123.164   &lt;none&gt;        80:30884/TCP   7d
</span></span><span style="display:flex;"><span>svc-nginx    ClusterIP   10.96.227.84    &lt;none&gt;        80/TCP         5s
</span></span></code></pre></div><p>如果正常部署，NodePort类型的service可以通过<code>本机ip:30884</code>访问，但我的cluster来自于kind，并不能这样访问。</p>
</li>
</ul>
<h2 id="5-pod详解">5 Pod详解</h2>
<h3 id="pod结构">pod结构</h3>
<p>pod包含一个或多个容器：</p>
<ul>
<li>user container 用户容器</li>
<li>pause container 根容器</li>
</ul>
<p>查看pod的可配置项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl explain pod
</span></span><span style="display:flex;"><span>kubectl explain pod.metadata  <span style="color:#75715e"># 用.查看子属性</span>
</span></span></code></pre></div><p>一级属性：</p>
<ul>
<li>
<p>apiVersion  <!-- raw HTML omitted -->：版本，用<code>kubectl api-versions</code>查询。</p>
</li>
<li>
<p>kind <!-- raw HTML omitted -->：类型，用<code>kubectl api-resources</code>查询。</p>
</li>
<li>
<p>metadata  <!-- raw HTML omitted -->：元数据，主要是资源标识和说明，常用的有name、namespace、labels等。</p>
</li>
<li>
<p>spec <!-- raw HTML omitted -->：描述，这是配置中最重要的一部分，里面是对各种资源配置的详细描述。</p>
</li>
<li>
<p>status  <!-- raw HTML omitted -->：状态信息，里面的内容不需要定义，由kubernetes自动生成。</p>
</li>
</ul>
<p>在上面的属性中，spec是接下来研究的重点，继续看下它的常见子属性：</p>
<ul>
<li>
<p>containers  &lt;[]Object&gt;：容器列表，用于定义容器的详细信息。</p>
</li>
<li>
<p>nodeName <!-- raw HTML omitted -->：根据nodeName的值将Pod调度到指定的Node节点上。</p>
</li>
<li>
<p>nodeSelector  &lt;[]map&gt; ：根据NodeSelector中定义的信息选择该Pod调度到包含这些Label的Node上。</p>
</li>
<li>
<p>hostNetwork  <!-- raw HTML omitted -->：是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络。</p>
</li>
<li>
<p>volumes    &lt;[]Object&gt; ：存储卷，用于定义Pod上面挂载的存储信息。</p>
</li>
<li>
<p>restartPolicy	<!-- raw HTML omitted -->：重启策略，表示Pod在遇到故障的时候的处理策略。</p>
</li>
</ul>
<h3 id="podspeccontainers配置">pod.spec.containers配置</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl explain pod.spec.containers
</span></span></code></pre></div><p>一些重要属性：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">KIND</span>:     <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">VERSION</span>:  <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">RESOURCE</span>: <span style="color:#f92672">containers &lt;[]Object&gt;   # 数组，代表可以有多个容器FIELDS</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">name  &lt;string&gt;    </span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">image &lt;string&gt;    </span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">imagePullPolicy  &lt;string&gt;</span> <span style="color:#75715e"># 镜像拉取策略 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">command  &lt;[]string&gt;</span> <span style="color:#75715e"># 容器的启动命令列表，如不指定，使用打包时使用的启动命令</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">args   &lt;[]string&gt;</span> <span style="color:#75715e"># 容器的启动命令需要的参数列表 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">env    &lt;[]Object&gt;</span> <span style="color:#75715e"># 容器环境变量的配置</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">ports  &lt;[]Object&gt; </span> <span style="color:#75715e"># 容器需要暴露的端口号列表</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">resources &lt;Object&gt;</span> <span style="color:#75715e"># 资源限制和资源请求的设置</span>
</span></span></code></pre></div><h4 id="镜像拉取策略-speccontainersimagepullpolicy">镜像拉取策略 spec.containers.imagePullPolicy</h4>
<p>三种镜像拉取策略：</p>
<ul>
<li>Always：总是从远程仓库拉取镜像</li>
<li>IfNotPresent：本地有则使用本地镜像，本地没有则从远程仓库拉取镜像</li>
<li>Never：只使用本地镜像，从不去远程仓库拉取，本地没有就报错</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-imagepullpolicy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always</span> <span style="color:#75715e"># 用于设置镜像的拉取策略</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span></code></pre></div><p>默认值说明：</p>
<ul>
<li>
<p>如果镜像tag为具体的版本号，默认策略是IfNotPresent</p>
</li>
<li>
<p>如果镜像tag为latest，默认策略是Always</p>
</li>
</ul>
<h4 id="启动命令-speccontainerscommand">启动命令 spec.containers.command</h4>
<p>用于在Pod中的容器初始化完毕之后执行一个命令，可以覆盖Dockerfile中的ENTRYPOINT（可配合args使用）。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-command</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span> <span style="color:#75715e"># 设置镜像拉取策略</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;touch /tmp/hello.txt;while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt;sleep 3;done;&#34;</span>]
</span></span></code></pre></div><h4 id="环境变量-speccontainersenv">环境变量 spec.containers.env</h4>
<p>key:value键值对，用于在Pod中的容器设置环境变量。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-env</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span> <span style="color:#75715e"># 设置镜像拉取策略</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;touch /tmp/hello.txt;while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt;sleep 3;done;&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;username&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;admin&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;password&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span></code></pre></div><p>进入容器，输出环境变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl exec -it pod-env -n dev -c busybox -it /bin/sh
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># echo $username</span>
</span></span></code></pre></div><p>此种方式不推荐，推荐将这些配置单独存储在配置文件中。</p>
<h4 id="端口设置-speccontainersports">端口设置 spec.containers.ports</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">KIND</span>:     <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">VERSION</span>:  <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">RESOURCE</span>: <span style="color:#ae81ff">ports &lt;[]Object&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">FIELDS</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">name &lt;string&gt;</span> <span style="color:#75715e"># 端口名称，如果指定，必须保证name在pod中是唯一的</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">containerPort &lt;integer&gt;</span> <span style="color:#75715e"># 容器要监听的端口(0&lt;x&lt;65536)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">hostPort &lt;integer&gt;</span> <span style="color:#75715e"># 容器要在主机上公开的端口，如果设置，主机上只能运行容器的一个副本(一般省略）</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">hostIP &lt;string&gt; </span> <span style="color:#75715e"># 要将外部端口绑定到的主机IP(一般省略)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">protocol &lt;string&gt; </span> <span style="color:#75715e"># 端口协议。必须是UDP、TCP或SCTP。默认为“TCP”</span>
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-ports</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span> <span style="color:#75715e"># 设置镜像拉取策略</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span> <span style="color:#75715e"># 端口名称，如果执行，必须保证name在Pod中是唯一的</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 容器要监听的端口 （0~65536）</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span> <span style="color:#75715e"># 端口协议</span>
</span></span></code></pre></div><p>可使用podIP:containerPort访问Pod中的容器中</p>
<h4 id="资源配额-speccontainersresources">资源配额 spec.containers.resources</h4>
<p>resources用于对内存和CPU的资源进行配额，有两个子选项：</p>
<p>(1) limits：容器的最大占用资源，当容器占用资源超过limits时会被终止，并进行重启。</p>
<p>(2) requests：容器需要的最小资源，如果环境资源不够，容器将无法启动（pending）。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-resoures</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span> <span style="color:#75715e"># 设置镜像拉取策略</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>: <span style="color:#75715e"># 端口设置</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span> <span style="color:#75715e"># 端口名称，如果执行，必须保证name在Pod中是唯一的</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 容器要监听的端口 （0~65536）</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span> <span style="color:#75715e"># 端口协议</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>: <span style="color:#75715e"># 资源配额</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">limits</span>: <span style="color:#75715e"># 限制资源的上限</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;2&#34;</span> <span style="color:#75715e"># CPU限制，单位是core数，可以为整数或小数。</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;10Gi&#34;</span> <span style="color:#75715e"># 内存限制，可以使用Gi、Mi、G、M等形式</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">requests</span>: <span style="color:#75715e"># 限制资源的下限</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;10Mi&#34;</span>
</span></span></code></pre></div><h3 id="pod生命周期">pod生命周期</h3>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:100%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-4.png" />
    </div>
    <a href="/image/heima-note-4.png" itemprop="contentUrl"></a>
  </figure>
</div>

<h4 id="初始化容器-specinitcontainers">初始化容器 spec.initContainers：</h4>
<p>初始化容器是在Pod的主容器启动之前要运行的容器，一般用于使容器满足前置依赖条件。它必须按照定义的顺序执行，并且必须运行成功才能启动主容器。</p>
<p>示例：假设要以主容器来运行Nginx，但是要求在运行Nginx之前要能够连接上MySQL和Redis所在的服务器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-initcontainer</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>: <span style="color:#75715e"># 容器配置</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;2&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;10Gi&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;10Mi&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">initContainers</span>: <span style="color:#75715e"># 初始化容器配置</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test-mysql</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;until ping 192.168.18.103 -c 1;do echo waiting for mysql ...;sleep 2;done;&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 使用特权模式运行容器</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test-redis</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;until ping 192.168.18.104 -c 1;do echo waiting for redis ...;sleep 2;done;&#34;</span>]
</span></span></code></pre></div><h4 id="钩子函数-speccontainerslifecyclepoststartprestop">钩子函数 spec.containers.lifecycle.postStart/preStop</h4>
<p>kubernetes在主容器启动之后和停止之前提供了两个钩子函数：</p>
<ul>
<li>post start：容器创建之后执行，如果失败会重启容器。</li>
<li>pre stop：容器终止之前执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作。</li>
</ul>
<p>钩子处理器支持的定义动作（新版本有更新？）：</p>
<ul>
<li>
<p>exec：在容器内执行一次命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">……</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">lifecycle</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">postStart</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>             - <span style="color:#ae81ff">cat</span>
</span></span><span style="display:flex;"><span>             - <span style="color:#ae81ff">/tmp/healthy</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">……</span>
</span></span></code></pre></div></li>
<li>
<p>tcpSocket：在当前容器尝试访问指定的socket</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">…… </span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">lifecycle</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">postStart</span>:
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">……</span>
</span></span></code></pre></div></li>
<li>
<p>httpGet：在当前容器中向某url发起HTTP请求</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">…… </span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">lifecycle</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">postStart</span>:
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span> <span style="color:#75715e">#URI地址</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e">#端口号</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.109.100</span> <span style="color:#75715e">#主机地址  </span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span> <span style="color:#75715e">#支持的协议，http或者https</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">……</span>
</span></span></code></pre></div></li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-hook-exec</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>: <span style="color:#75715e"># 容器配置</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">lifecycle</span>: <span style="color:#75715e"># 生命周期配置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">postStart</span>: <span style="color:#75715e"># 容器创建之后执行，如果失败会重启容器</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">exec</span>: <span style="color:#75715e"># 在容器启动的时候，执行一条命令，修改掉Nginx的首页内容</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;echo postStart ... &gt; /usr/share/nginx/html/index.html&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">preStop</span>: <span style="color:#75715e"># 容器终止之前执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">exec</span>: <span style="color:#75715e"># 在容器停止之前停止Nginx的服务</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/usr/sbin/nginx&#34;</span>,<span style="color:#e6db74">&#34;-s&#34;</span>,<span style="color:#e6db74">&#34;quit&#34;</span>]
</span></span></code></pre></div><h4 id="容器探测-speccontainerslivenessprobereadinessprobe">容器探测 spec.containers.livenessProbe/readinessProbe</h4>
<p>容器探测用于检测容器中的应用实例是否正常工作。如果实例的状态不符合预期，那么kubernetes就会把该问题实例“摘除”，不承担业务流量。kubernetes提供了两种探针来实现容器探测，分别是：</p>
<ul>
<li>liveness probe：存活性探测，用于检测应用实例当前是否处于正常运行状态，如果不是，k8s会<strong>重启容器</strong>。</li>
<li>readiness probe：就绪性探测，用于检测应用实例是否可以接受请求，如果不能，k8s<strong>不会转发流量</strong>（不会重启）。</li>
</ul>
<p>k8s在1.16版本之后新增了startupProbe探针，用于判断容器内应用程序是否已经启动。如果配置了startupProbe探针，就会先禁止其他的探针，直到startupProbe探针成功为止，一旦成功将不再进行探测。</p>
<p>探针的动作与钩子函数相同，分别是exec、tcpSocket和httpGet。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-liveness-exec</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>: <span style="color:#75715e"># 容器配置</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">livenessProbe</span>: <span style="color:#75715e"># 存活性探针</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/cat&#34;</span>,<span style="color:#e6db74">&#34;/tmp/hello.txt&#34;</span>] <span style="color:#75715e"># 执行一个查看文件的命令，必须失败，因为根本没有这个文件</span>
</span></span></code></pre></div><p>探针可配置的其他参数有：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt;&gt; kubectl explain pod.spec.containers.livenessProbe
</span></span><span style="display:flex;"><span>exec 
</span></span><span style="display:flex;"><span>tcpSocket  
</span></span><span style="display:flex;"><span>httpGet   
</span></span><span style="display:flex;"><span>initialDelaySeconds   <span style="color:#75715e"># 容器启动后等待多少秒执行第一次探测</span>
</span></span><span style="display:flex;"><span>timeoutSeconds    <span style="color:#75715e"># 探测超时时间。默认1秒，最小1秒</span>
</span></span><span style="display:flex;"><span>periodSeconds    <span style="color:#75715e"># 执行探测的频率。默认是10秒，最小1秒</span>
</span></span><span style="display:flex;"><span>failureThreshold   <span style="color:#75715e"># 连续探测失败多少次才被认定为失败。默认是3。最小值是1</span>
</span></span><span style="display:flex;"><span>successThreshold   <span style="color:#75715e"># 连续探测成功多少次才被认定为成功。默认是1</span>
</span></span></code></pre></div><h4 id="重启策略-specrestartpolicy">重启策略 spec.restartPolicy</h4>
<p>pod的重启策略：</p>
<ul>
<li>Always：容器失效时，自动重启该容器，默认值。</li>
<li>OnFailure：容器终止运行且退出码不为0时重启。</li>
<li>Never：不论状态如何，都不重启该容器。</li>
</ul>
<p>重启策略适用于Pod对象中的所有容器，首次需要重启的容器将立即进行重启，随后再次重启的操作将由kubelet延迟一段时间后进行，且反复的重启操作的延迟时长以此为10s、20s、40s、80s、160s和300s，300s是最大的延迟时长。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-restart-policy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>: <span style="color:#75715e"># 容器配置</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">livenessProbe</span>: <span style="color:#75715e"># 存活性探测</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/hello</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">host</span>: <span style="color:#ae81ff">127.0.0.1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never</span> <span style="color:#75715e"># 重启策略</span>
</span></span></code></pre></div><h3 id="pod调度">pod调度</h3>
<p>四种pod调度方式：</p>
<p>（1）自动调度：运行在哪个Node节点上由Scheduler经过的算法计算得出（默认）</p>
<p>（2）定向调度：NodeName、NodeSelector</p>
<p>（3）亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity</p>
<p>（4）污点（容忍）调度：Taints、Toleration</p>
<h4 id="定向调度">定向调度</h4>
<p>配置<code>spec.nodeName</code>或<code>spec.nodeSelector</code>从而将Pod调度到期望的Node节点上。</p>
<p>这里的调度是强制的，即使要调度的目标Node不存在，也会向上面进行调度，但Pod运行会失败。</p>
<p>nodeName用于根据node name将Pod调度到指定的Node上。示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-nodename</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>: <span style="color:#75715e"># 容器配置</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeName</span>: <span style="color:#ae81ff">k8s-node1</span> <span style="color:#75715e"># 指定调度到k8s-node1节点上</span>
</span></span></code></pre></div><p>nodeSelector用于将Pod调度到添加了指定label的Node上，它是通过kubernetes的label-selector机制实现的。示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl label node k8s-node1 nodeenv<span style="color:#f92672">=</span>pro
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-nodeselector</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>: <span style="color:#75715e"># 容器配置</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeSelector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodeenv</span>: <span style="color:#ae81ff">pro</span> <span style="color:#75715e"># 指定调度到具有nodeenv=pro的Node节点上</span>
</span></span></code></pre></div><h4 id="亲和性调度">亲和性调度</h4>
<p>定向调度的问题：强制调度，如果没有满足条件的Node，Pod将不会被运行</p>
<p>基于上面的问题，kubernetes还提供了一种亲和性调度（Affinity）。它在nodeSelector的基础之上进行了扩展，可以优先选择满足条件的Node进行调度，如果没有，也可以调度到不满足条件的节点上，使得调度更加灵活。</p>
<p>Affinity主要分为三类：</p>
<ul>
<li>nodeAffinity（node亲和性）：以Node为目标，解决Pod可以调度到哪些Node的问题。</li>
<li>podAffinity（pod亲和性）：以Pod为目标，解决Pod可以和那些已存在的Pod部署在同一个拓扑域中的问题。</li>
<li>podAntiAffinity（pod反亲和性）：以Pod为目标，解决Pod不能和那些已经存在的Pod部署在同一拓扑域中的问题。</li>
</ul>
<p>关于亲和性和反亲和性的使用场景的说明：</p>
<ul>
<li>亲和性：如果两个应用频繁交互，那么就有必要利用亲和性让两个应用尽可能的靠近，这样可以较少因网络通信而带来的性能损耗。</li>
<li>反亲和性：当应用采用多副本部署的时候，那么就有必要利用反亲和性让各个应用实例打散分布在各个Node上，这样可以提高服务的高可用性。</li>
</ul>
<p>nodeAffinity包含<code>requiredDuringSchedulingIgnoredDuringExecution</code>和<code>preferredDuringSchedulingIgnoredDuringExecution</code>两种：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">pod.spec.affinity.nodeAffinity</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">requiredDuringSchedulingIgnoredDuringExecution  Node必须满足指定的所有规则才可以，相当于硬限制</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">nodeSelectorTerms  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">matchFields   按node字段选择  </span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">matchExpressions   按node标签选择(推荐)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">key    键</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">values 值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">operator 关系符 支持Exists, DoesNotExist, In, NotIn, Gt, Lt</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">preferredDuringSchedulingIgnoredDuringExecution 优先调度到满足指定的规则的Node，相当于软限制 (倾向)     </span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">preference   </span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">matchFields 按node字段选择 </span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">matchExpressions   按node标签选择(推荐)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">key 键</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">values 值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">operator 关系符 支持In, NotIn, Exists, DoesNotExist, Gt, Lt  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">weight 倾向权重，在范围1-100。</span>
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-nodeaffinity-preferred</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>: <span style="color:#75715e"># 容器配置</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>: <span style="color:#75715e"># 亲和性配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodeAffinity</span>: <span style="color:#75715e"># node亲和性配置</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">preferredDuringSchedulingIgnoredDuringExecution</span>: <span style="color:#75715e"># 优先调度到满足指定的规则的Node，相当于软限制 (倾向)</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">preference</span>: <span style="color:#75715e"># 一个节点选择器项，与相应的权重相关联</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">nodeenv  </span> <span style="color:#75715e"># 优先匹配存在标签的key为nodeenv的节点，并且value是&#34;xxx&#34;或&#34;yyy&#34;的节点</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>                  - <span style="color:#e6db74">&#34;xxx&#34;</span>
</span></span><span style="display:flex;"><span>                  - <span style="color:#e6db74">&#34;yyy&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>nodeAffinity的注意事项：</p>
<ul>
<li>
<p>如果同时定义了nodeSelector和nodeAffinity，那么必须两个条件都满足，Pod才能运行在指定的Node上。</p>
</li>
<li>
<p>如果nodeAffinity指定了多个nodeSelectorTerms，那么只需要其中一个能够匹配成功即可。</p>
</li>
<li>
<p>如果一个nodeSelectorTerm中有多个matchExpressions，则一个节点必须满足所有的才能匹配成功。</p>
</li>
<li>
<p>如果一个Pod所在的Node在Pod运行期间其标签发生了改变，不再符合该Pod的nodeAffinity的要求，则系统将忽略此变化。</p>
</li>
</ul>
<p>PodAffinity与podAntiAffinity（以PodAffinity为例）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">pod.spec.affinity.podAffinity</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">requiredDuringSchedulingIgnoredDuringExecution  硬限制</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">namespaces 指定参照pod的namespace</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">topologyKey 指定调度作用域</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">labelSelector 标签选择器</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">matchExpressions  按节点标签列出的节点选择器要求列表(推荐)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">key    键</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">values 值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">operator 关系符 支持In, NotIn, Exists, DoesNotExist.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">matchLabels    指多个matchExpressions映射的内容  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">preferredDuringSchedulingIgnoredDuringExecution 软限制    </span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">podAffinityTerm  选项</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">namespaces</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">topologyKey</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">labelSelector</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">matchExpressions </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">key    键  </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">values 值  </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">operator</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">matchLabels </span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">weight 倾向权重，在范围1-1</span>
</span></span></code></pre></div><p>topologyKey用于指定调度的作用域，例如:</p>
<ul>
<li>
<p>如果指定为kubernetes.io/hostname，那就是以Node节点为区分范围。</p>
</li>
<li>
<p>如果指定为beta.kubernetes.io/os，则以Node节点的操作系统类型来区分。</p>
</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-podaffinity-requred</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>: <span style="color:#75715e"># 容器配置</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>: <span style="color:#75715e"># 亲和性配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">podAffinity</span>: <span style="color:#75715e"># Pod亲和性</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requiredDuringSchedulingIgnoredDuringExecution</span>: <span style="color:#75715e"># 硬限制</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">labelSelector</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># 该Pod必须和拥有标签podenv=xxx或者podenv=yyy的Pod在同一个Node上</span>
</span></span><span style="display:flex;"><span>              - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">podenv</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>                  - <span style="color:#e6db74">&#34;xxx&#34;</span>
</span></span><span style="display:flex;"><span>                  - <span style="color:#e6db74">&#34;yyy&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">topologyKey</span>: <span style="color:#ae81ff">kubernetes.io/hostname</span>
</span></span></code></pre></div><h4 id="污点taints和容忍toleration">污点(Taints)和容忍(Toleration)</h4>
<p>在Node的角度上，通过在Node上添加污点（拒绝策略），来决定是否接受Pod调度过来。</p>
<p>污点的格式：<code>key=value:effect</code>（似乎可以没有value，只有key和effect）</p>
<p>key和value是污点的标签，effect描述污点的作用，支持如下三个选项：</p>
<ul>
<li>PreferNoSchedule</li>
<li>NoSchedule（通常Master节点会有一个默认NoSchedule污点）</li>
<li>NoExecute</li>
</ul>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:100%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-5.png" />
    </div>
    <a href="/image/heima-note-5.png" itemprop="contentUrl"></a>
  </figure>
</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 设置污点</span>
</span></span><span style="display:flex;"><span>kubectl taint node xxx key<span style="color:#f92672">=</span>value:effect
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除污点</span>
</span></span><span style="display:flex;"><span>kubectl taint node xxx key:effect-
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除所有污点</span>
</span></span><span style="display:flex;"><span>kubectl taint node xxx key-
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看指定节点上的污点</span>
</span></span><span style="display:flex;"><span>kubectl describe node xxx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 列出所有节点的污点</span>
</span></span><span style="display:flex;"><span>kubectl get nodes -o json | jq <span style="color:#e6db74">&#39;.items[].spec&#39;</span>
</span></span><span style="display:flex;"><span>kubectl get nodes -o json | jq <span style="color:#e6db74">&#39;.items[].spec.taints&#39;</span>
</span></span></code></pre></div><p>对应的，容忍相当于忽略策略。Node通过污点拒绝Pod调度上去，Pod通过容忍忽略拒绝。</p>
<p>容忍配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">kubectl explain pod.spec.tolerations</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">FIELDS</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">key      </span> <span style="color:#75715e"># 要容忍的污点的键，空意味着匹配所有的键</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">value    </span> <span style="color:#75715e"># 要容忍的污点的值</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">operator  # key-value的运算符，支持Equal和Exists（默认，Exists只匹配key是否存在）</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">effect    # 对应污点的effect，空意味着匹配所有影响</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">tolerationSeconds  </span> <span style="color:#75715e"># 容忍时间, 当effect为NoExecute时生效，表示pod在Node上的停留时间</span>
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-toleration</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>: <span style="color:#75715e"># 容器配置</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tolerations</span>: <span style="color:#75715e"># 容忍</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;tag&#34;</span> <span style="color:#75715e"># 要容忍的污点的key</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">Equal</span> <span style="color:#75715e"># 操作符</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;pro&#34;</span> <span style="color:#75715e"># 要容忍的污点的value</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">effect</span>: <span style="color:#ae81ff">NoExecute</span> <span style="color:#75715e"># 添加容忍的规则，这里必须和标记的污点规则相同</span>
</span></span></code></pre></div><h2 id="6-pod控制器">6 Pod控制器</h2>
<p>在kubernetes中，Pod的创建方式有两类：</p>
<ul>
<li>自主式Pod：删除后不会重建。</li>
<li>控制器创建Pod：控制器可以指定Pod数量，保证每一个Pod处于用户期望的状态。如果Pod在运行中出现故障，控制器会基于指定的策略重启或重建Pod。</li>
</ul>
<p>常见Pod控制器类型：</p>
<ul>
<li>ReplicaSet：保证指定数量的Pod运行，支持Pod数量变更。</li>
<li>Deployment：通过控制ReplicaSet来控制Pod，并支持滚动升级、版本回退。</li>
<li>Horizontal Pod Autoscaler：可以根据集群负载自动调整Pod的数量，实现削峰填谷。</li>
<li>DaemonSet：在集群中的指定Node上都运行一个副本，一般用于守护进程类的任务。</li>
<li>Job：创建执行一次性任务的Pod。</li>
<li>CronJob：创建执行周期性的任务的Pod。</li>
<li>StatefulSet：管理有状态的应用。</li>
</ul>
<h3 id="replicaset">ReplicaSet</h3>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:70%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-6.png" />
    </div>
    <a href="/image/heima-note-6.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>yaml：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># 版本号 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicaSet</span> <span style="color:#75715e"># 类型 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#75715e"># rs名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#75715e"># 所属命名空间 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: <span style="color:#75715e">#标签 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">rs </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># 详情描述 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 副本数量 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># 选择器，通过它指定该控制器管理哪些po</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>: <span style="color:#75715e"># Labels匹配规则，与template中的label对应</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># Expressions匹配规则，可省略</span>
</span></span><span style="display:flex;"><span>      - {<span style="color:#f92672">key: app, operator: In, values</span>: [<span style="color:#ae81ff">nginx-pod]} </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">template</span>: <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建pod副本 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metadata</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">spec</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">containers</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx </span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1 </span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>: 
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><p>扩缩容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 方法1: 编辑yaml中的spec.replicas</span>
</span></span><span style="display:flex;"><span>kubectl edit rs xxx -n ns
</span></span><span style="display:flex;"><span>kubectl apply -f rs.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 方法2: 使用scale命令</span>
</span></span><span style="display:flex;"><span>kubectl scale rs xxx --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> -n ns
</span></span></code></pre></div><h3 id="deployment-1">Deployment</h3>
<p>Deployment通过管理ReplicaSet来管理Pod。在ReplicaSet的基础上，Deployment额外支持：</p>
<ul>
<li>发布的停止、继续</li>
<li>版本滚动更新和版本回退</li>
</ul>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:70%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-7.png" />
    </div>
    <a href="/image/heima-note-7.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>yaml：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># 版本号 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span> <span style="color:#75715e"># 类型 </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#75715e"># rs名称 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#75715e"># 所属命名空间 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: <span style="color:#75715e">#标签 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">deploy </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># 详情描述 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 副本数量 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 保留历史版本，默认为10 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paused</span>: <span style="color:#66d9ef">false</span> <span style="color:#75715e"># 暂停部署，默认是false </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span> <span style="color:#75715e"># 部署超时时间（s），默认是600 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>: <span style="color:#75715e"># 策略 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span> <span style="color:#75715e"># 滚动更新策略 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>: <span style="color:#75715e"># 滚动更新 </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge: 30% # 最大额外可以存在的副本数，可以为百分比，也可以为整数 maxUnavailable</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%</span> <span style="color:#75715e"># 最大不可用状态的    Pod 的最大值，可以为百分比，也可以为整数 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># 选择器，通过它指定该控制器管理哪些pod </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>: <span style="color:#75715e"># Labels匹配规则，与template中的label对应</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># Expressions匹配规则，可省略</span>
</span></span><span style="display:flex;"><span>      - {<span style="color:#f92672">key: app, operator: In, values</span>: [<span style="color:#ae81ff">nginx-pod]} </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>: <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建pod副本 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx </span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1 </span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>: 
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><h4 id="创建deployment">创建Deployment</h4>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-deployment</span> <span style="color:#75715e"># deployment的名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span> <span style="color:#75715e"># 命名类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># 详细描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 副本数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># 选择器，通过它指定该控制器可以管理哪些Pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>: <span style="color:#75715e"># Labels匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>: <span style="color:#75715e"># 模块 当副本数据不足的时候，会根据下面的模板创建Pod副本</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 容器所监听的端口</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create -f pc-deployment.yaml
</span></span></code></pre></div><h4 id="扩缩容">扩缩容</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 方法1: 编辑yaml中的spec.replicas</span>
</span></span><span style="display:flex;"><span>kubectl edit deployment pc-deployment -n ns
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 方法2: 使用scale命令</span>
</span></span><span style="display:flex;"><span>kubectl scale deploy pc-deployment --replicas<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> -n ns
</span></span></code></pre></div><h4 id="镜像更新">镜像更新</h4>
<p>Deployment支持两种镜像更新的策略——<strong>重建更新</strong>和<strong>滚动更新</strong>（默认），可以通过<code>spec.strategy</code>进行配置：</p>
<pre tabindex="0"><code>strategy:
  type: 
    Recreate     # 在创建出新的Pod之前会先杀掉所有已经存在的Pod
    RollingUpdate     #滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本的Pod
  rollingUpdate：    # 用于为rollingUpdate设置参数，支持两个属性：
    maxUnavailable：25%     # 用来指定在升级过程中不可用的Pod的最大数量，默认为25%。
    maxSurge：25%     # 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%。
</code></pre><p><strong>重建更新（Recreate）：</strong></p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-deployment</span> <span style="color:#75715e"># deployment的名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span> <span style="color:#75715e"># 命名类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># 详细描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 副本数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>: <span style="color:#75715e"># 镜像更新策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Recreate</span> <span style="color:#75715e"># Recreate：在创建出新的Pod之前会先杀掉所有已经存在的Pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># 选择器，通过它指定该控制器可以管理哪些Pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>: <span style="color:#75715e"># Labels匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>: <span style="color:#75715e"># 模块 当副本数据不足的时候，会根据下面的模板创建Pod副本</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 容器所监听的端口</span>
</span></span></code></pre></div><p>升级镜像：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl set image deployment pc-deployment nginx<span style="color:#f92672">=</span>nginx:1.17.2 -n dev
</span></span></code></pre></div><p>监控升级过程：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get pod -n dev -w
</span></span></code></pre></div><p>Deployment会在创建出新的Pod之前终止所有已经存在的Pod。</p>
<p><strong>滚动更新（RollingUpdate）：</strong></p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-deployment</span> <span style="color:#75715e"># deployment的名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span> <span style="color:#75715e"># 命名类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># 详细描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 副本数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>: <span style="color:#75715e"># 镜像更新策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span> <span style="color:#75715e"># RollingUpdate：滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本的Pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># 选择器，通过它指定该控制器可以管理哪些Pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>: <span style="color:#75715e"># Labels匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>: <span style="color:#75715e"># 模块 当副本数据不足的时候，会根据下面的模板创建Pod副本</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span> <span style="color:#75715e"># 容器名称</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span> <span style="color:#75715e"># 容器需要的镜像地址</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># 容器所监听的端口</span>
</span></span></code></pre></div><p>Deployment会停止一个旧版本并启动一个新版本，更新过程中同时存在两个版本。</p>
<p>镜像更新中rs的变化：在更新后原来的rs依旧存在，只是Pod的数量变为0，新创建的rs中Pod的数量为3。这是deployment能够进行版本回退的原因。</p>
<h4 id="版本回退">版本回退</h4>
<p>rollout操作：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubetl rollout <span style="color:#f92672">{</span>opt<span style="color:#f92672">}</span> deploy pc-deployment
</span></span><span style="display:flex;"><span><span style="color:#75715e"># status 显示当前升级的状态</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># history 显示升级历史记录</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># undo 回滚到上一级版本 （可以使用--to-revision回滚到指定的版本）</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pause 暂停版本升级过程</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># resume 继续已经暂停的版本升级过程</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># restart 重启版本升级过程</span>
</span></span></code></pre></div><p>查看当前升级版本的状态：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt;&gt; kubectl rollout status deployment pc-deployment -n ns
</span></span><span style="display:flex;"><span>deployment <span style="color:#e6db74">&#34;pc-deployment&#34;</span> successfully rolled out  
</span></span></code></pre></div><p>查看升级历史记录：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt;&gt; kubectl rollout history deployment pc-deployment -n ns
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment
</span></span><span style="display:flex;"><span>REVISION   CHANGE-CAUSE
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>           &lt;none&gt; <span style="color:#f92672">(</span>需要在启动时加--record才能显示具体记录<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>           &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>           &lt;none&gt;
</span></span></code></pre></div><p>版本回退：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 可以使用-to-revision=1回退到1版本，如果省略这个选项，就是回退到上个版本，即2版本</span>
</span></span><span style="display:flex;"><span>&gt;&gt; kubectl rollout undo deployment pc-deployment --to-revision<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> -n ns
</span></span><span style="display:flex;"><span>deployment <span style="color:#e6db74">&#34;pc-deployment&#34;</span> rolled back  
</span></span></code></pre></div><h3 id="horizontal-pod-autoscalerhpa">Horizontal Pod Autoscaler（HPA）</h3>
<p>HPA可以获取每个Pod的利用率（负载变化情况），与HPA中定义的指标对比，计算出需要伸缩的具体值，实现Pod数量的自适应调整。</p>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:100%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-8.png" />
    </div>
    <a href="/image/heima-note-8.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>hpa示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">autoscaling/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">HorizontalPodAutoscaler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-hpa</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReplicas</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># 最小Pod数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">maxReplicas</span>: <span style="color:#ae81ff">10</span> <span style="color:#75715e"># 最大Pod数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">targetCPUUtilizationPercentage</span>: <span style="color:#ae81ff">30</span> <span style="color:#75715e"># CPU使用率指标 - 30%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scaleTargetRef</span>:  <span style="color:#75715e"># 指定要控制的Nginx的信息</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create -f pc-hpa.yaml
</span></span><span style="display:flex;"><span>kubectl get hpa -n dev
</span></span></code></pre></div><h4 id="准备工作安装metrics-server">准备工作：安装metrics-server</h4>
<p>（1）下载 metrics-server 官方的部署 yaml，目前更新到0.6.4</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
</span></span></code></pre></div><p>（2）修改components.yaml</p>
<p>metrics-server 会请求每台节点的 kubelet 接口来获取监控数据，接口通过 HTTPS 暴露，但 Kubernetes 节点的 kubelet 使用的是自签证书，若 metrics-server 直接请求 kubelet 接口，将产生证书校验失败的错误，因此需要在 components.yaml 文件中加上 &ndash;kubelet-insecure-tls 启动参数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>  - --<span style="color:#ae81ff">cert-dir=/tmp</span>
</span></span><span style="display:flex;"><span>  - --<span style="color:#ae81ff">secure-port=443</span>
</span></span><span style="display:flex;"><span>  - --<span style="color:#ae81ff">kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span>
</span></span><span style="display:flex;"><span>  - --<span style="color:#ae81ff">kubelet-use-node-status-port</span>
</span></span><span style="display:flex;"><span>  - --<span style="color:#ae81ff">metric-resolution=15s</span>
</span></span><span style="display:flex;"><span>  - --<span style="color:#ae81ff">kubelet-insecure-tls</span> <span style="color:#75715e"># 加上该启动参数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.k8s.io/metrics-server/metrics-server:v0.6.4</span> <span style="color:#75715e"># 需要代理！！！</span>
</span></span></code></pre></div><p>（3）部署 metrics-server</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f components.yaml
</span></span></code></pre></div><p>检查pod 状态：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get pod -n kube-system | grep metrics-server
</span></span></code></pre></div><p>检查pod资源占用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">kubectl top nodes</span>
</span></span></code></pre></div><h3 id="daemonsetds">DaemonSet（DS）</h3>
<p>DaemonSet可以保证集群中的每一台（或指定）节点上都运行一个pod副本，一般适用于日志收集、节点监控等场景。每向cluster中添加一个node，指定的Pod副本也将添加到该node上。</p>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:100%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-9.png" />
    </div>
    <a href="/image/heima-note-9.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>yaml（与前面类似）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet</span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#75715e"># 名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#75715e">#命名空间</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: <span style="color:#75715e">#标签</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">daemonset</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># 详情描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 保留历史版本</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>: <span style="color:#75715e"># 更新策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span> <span style="color:#75715e"># 滚动更新策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>: <span style="color:#75715e"># 滚动更新</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># 最大不可用状态的Pod的最大值，可用为百分比，也可以为整数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># 选择器，通过它指定该控制器管理那些Pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>: <span style="color:#75715e"># Labels匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># Expressions匹配规则</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">app</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>: <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>         - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>             - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><h3 id="job">Job</h3>
<p>Job主要用于负责批量处理短暂的一次性任务。任务执行会创建pod，执行完毕pod的状态变为completed</p>
<p>yaml：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1</span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Job</span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>:  <span style="color:#75715e"># 名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>:  <span style="color:#75715e">#命名空间</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: <span style="color:#75715e"># 标签</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># 详情描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">completions</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># 指定Job需要成功运行Pod的总次数，默认为1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">parallelism</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># 指定Job在任一时刻应该并发运行Pod的数量，默认为1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#ae81ff">30</span> <span style="color:#75715e"># 指定Job可以运行的时间期限，超过时间还没结束，系统将会尝试进行终止</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">backoffLimit</span>: <span style="color:#ae81ff">6</span> <span style="color:#75715e"># 指定Job失败后进行重试的次数，默认为6</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">manualSelector</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 是否可以使用selector选择器选择Pod，默认为false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># 选择器，通过它指定该控制器管理那些Pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>: <span style="color:#75715e"># Labels匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># Expressions匹配规则</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">app</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>: <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never</span> <span style="color:#75715e"># 重启策略只能设置为Never或OnFailure</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>         - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">counter</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 20;done&#34;</span>]
</span></span></code></pre></div><p>关于模板中的重启策略的说明：</p>
<ul>
<li>
<p>如果设置为OnFailure，则Job会在Pod出现故障的时候重启容器，而不是创建Pod，failed次数不变。</p>
</li>
<li>
<p>如果设置为Never，则Job会在Pod出现故障的时候创建新的Pod，并且故障Pod不会消失，也不会重启，failed次数+1。</p>
</li>
<li>
<p>如果指定为Always的话，就意味着一直重启，意味着Pod任务会重复执行，这和Job的定义冲突，所以不能设置为Always。</p>
</li>
</ul>
<h3 id="cronjobcj">CronJob（CJ）</h3>
<p>CronJob通过管理Job，实现周期性执行Job。</p>
<p>yaml：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1beta1</span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CronJob</span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>:  <span style="color:#75715e"># 名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>:  <span style="color:#75715e">#命名空间</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">cronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># 详情描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedule</span>: <span style="color:#75715e"># cron格式的作业调度运行时间点，用于控制任务任务时间执行</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">concurrencyPolicy</span>: <span style="color:#75715e"># 并发执行策略</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">failedJobsHistoryLimit</span>: <span style="color:#75715e"># 为失败的任务执行保留的历史记录数，默认为1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">successfulJobsHistoryLimit</span>: <span style="color:#75715e"># 为成功的任务执行保留的历史记录数，默认为3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">jobTemplate</span>: <span style="color:#75715e"># job控制器模板，用于为cronjob控制器生成job对象，下面其实就是job的定义</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>: {}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">completions</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># 指定Job需要成功运行Pod的总次数，默认为1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">parallelism</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># 指定Job在任一时刻应该并发运行Pod的数量，默认为1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#ae81ff">30</span> <span style="color:#75715e"># 指定Job可以运行的时间期限，超过时间还没结束，系统将会尝试进行终止</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">backoffLimit</span>: <span style="color:#ae81ff">6</span> <span style="color:#75715e"># 指定Job失败后进行重试的次数，默认为6</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">template</span>: <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never</span> <span style="color:#75715e"># 重启策略只能设置为Never或OnFailure</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">counter</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">command</span>: [ <span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 20;done&#34;</span> ]
</span></span></code></pre></div><p>schedule：cron表达式，用于指定任务的执行时间。</p>
<ul>
<li>*/1  *  *  *  *：表示分钟  小时  日  月份  星期。</li>
<li>分钟的值从0到59。</li>
<li>小时的值从0到23。</li>
<li>日的值从1到31。</li>
<li>月的值从1到12。</li>
<li>星期的值从0到6，0表示星期日。</li>
<li>多个时间可以用逗号隔开，范围可以用连字符给出：* 可以作为通配符，/表示每&hellip;</li>
</ul>
<p>concurrencyPolicy：并发执行策略</p>
<ul>
<li>Allow：运行Job并发运行（默认）。</li>
<li>Forbid：禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行。</li>
<li>Replace：替换，取消当前正在运行的作业并使用新作业替换它。</li>
</ul>
<h2 id="7-service">7 Service</h2>
<h3 id="service基础">Service基础</h3>
<ul>
<li>Service会对提供同一个服务的多个Pod进行聚合，并且提供一个统一的入口地址，通过访问Service的入口地址访问对应的Pod服务。</li>
<li>Service在很多情况下只是一个概念，真正起作用的是Node上的kube-proxy服务进程。</li>
<li>四层路由。</li>
</ul>
<p>yaml配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span> <span style="color:#75715e"># 版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span> <span style="color:#75715e"># 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#75715e"># 资源名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#75715e"># 命名空间</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># 标签选择器，用于确定当前Service代理那些Pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span> <span style="color:#75715e"># Service的类型，指定Service的访问方式</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#75715e"># 虚拟服务的IP地址</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#75715e"># session亲和性，支持ClientIP、None两个选项，默认值为None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>: <span style="color:#75715e"># 端口信息</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span> <span style="color:#75715e"># Service端口</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span> <span style="color:#75715e"># 协议</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort </span>: <span style="color:#75715e"># Pod端口</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodePort</span>:  <span style="color:#75715e"># 主机端口</span>
</span></span></code></pre></div><p>spec.type的说明：</p>
<ul>
<li>ClusterIP：默认值，它是kubernetes系统自动分配的虚拟IP，只能在集群内部访问。</li>
<li>NodePort：将Service通过指定的Node上的端口暴露给外部，可以在集群外部访问服务。</li>
<li>LoadBalancer：使用外接负载均衡器完成到服务的负载分发，注意此模式需要外部云环境的支持。</li>
<li>ExternalName：把集群外部的服务引入集群内部。</li>
</ul>
<h3 id="不同类型service示例">不同类型Service示例</h3>
<h4 id="clusterip">ClusterIP</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-clusterip</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">10.97.97.97</span> <span style="color:#75715e"># service的IP地址，如果不写，默认会生成一个</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># Service的端口</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># Pod的端口</span>
</span></span></code></pre></div><p>可以在集群内部访问10.97.97.97:80。</p>
<h4 id="headliness">HeadLiness</h4>
<p>设置<code>clusterIP: None</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-headliness</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span> <span style="color:#75715e"># 将clusterIP设置为None，即可创建headliness Service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># Service的端口</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># Pod的端口</span>
</span></span></code></pre></div><p>这类Service不会分配Cluster IP，如果想要访问Service，只能通过Service的域名进行查询。</p>
<h4 id="nodeport">NodePort</h4>
<p>NodePort的工作原理是将Service的端口映射到Node的一个端口上，通过<code>NodeIP:NodePort</code>访问Service。</p>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:100%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-10.png" />
    </div>
    <a href="/image/heima-note-10.png" itemprop="contentUrl"></a>
  </figure>
</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-nodeport</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span> <span style="color:#75715e"># Service类型为NodePort</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># Service的端口</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># Pod的端口</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30002</span> <span style="color:#75715e"># 指定绑定的node的端口（默认取值范围是30000~32767），如果不指定，会默认分配</span>
</span></span></code></pre></div><h3 id="ingress">Ingress</h3>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:100%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-11.png" />
    </div>
    <a href="/image/heima-note-11.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>Ingress相当于一个七层的负载均衡器，是kubernetes对反向代理的一个抽象，它的工作原理类似于Nginx，可以理解为Ingress里面建立了诸多映射规则，Ingress Controller通过监听这些配置规则并转化为Nginx的反向代理配置，然后对外提供服务。</p>
<ul>
<li>Ingress：kubernetes中的一个对象，定义了请求如何转发到Service的规则。</li>
<li>Ingress Controller：具体实现反向代理及负载均衡的程序，对Ingress定义的规则进行解析，根据配置的规则来实现请求转发，实现的方式有Nginx、Contour、Haproxy等。</li>
</ul>
<p>安装ingress controller -&gt; contour</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt;&gt; kubectl get service -n projectcontour
</span></span><span style="display:flex;"><span>NAME      TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>                      AGE
</span></span><span style="display:flex;"><span>contour   ClusterIP      10.96.211.116   &lt;none&gt;        8001/TCP                     2d6h
</span></span><span style="display:flex;"><span>envoy     LoadBalancer   10.96.116.49    &lt;pending&gt;     80:31655/TCP,443:30244/TCP   2d6h
</span></span></code></pre></div><p>这里容器内的80端口（http）映射到cluster的31655端口，容器内的443端口（https）映射到cluster的30244端口。</p>
<p>Ingress http示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-http</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">nginx.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">nginx-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">tomcat.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">tomcat-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8080</span>
</span></span></code></pre></div><p>Ingress https示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create secret tls tls-secret --key tls.key --cert tls.crt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-https</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">nginx.com</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">tomcat.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">tls-secret</span> <span style="color:#75715e"># 指定秘钥</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">nginx.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">nginx-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">tomcat.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">tomcat-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8080</span>
</span></span></code></pre></div><h2 id="8-数据存储">8 数据存储</h2>
<p>为了持久化保存容器中的数据，kubernetes引入了Volume的概念。</p>
<p>Volume是Pod中能够被多个容器访问的共享目录，它被定义在Pod上，然后被一个Pod里面的多个容器挂载到具体的文件目录下，kubernetes通过Volume实现同一个Pod中不同容器之间的数据共享和持久化。</p>
<p>kubernetes的Volume支持多种类型，比较常见的有下面的几个：</p>
<ul>
<li>基本存储：EmptyDir、HostPath、NFS</li>
<li>高级存储：PV、PVC</li>
<li>配置存储：ConfigMap、Secret</li>
</ul>
<h3 id="基本存储">基本存储</h3>
<h4 id="emptydir">EmptyDir</h4>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:100%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-12.png" />
    </div>
    <a href="/image/heima-note-12.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>EmptyDir创建在节点临时存储中，在Pod被分配到Node时创建。<em><strong>当Pod销毁时，EmptyDir中的数据也会被永久删除。</strong></em></p>
<p>EmptyDir一般用于：</p>
<ul>
<li>临时空间，例如用于某些应用程序运行时所需的临时目录。</li>
<li>一个容器需要从另一个容器中获取数据的目录（多容器共享目录）。</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-emptydir</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到nginx容器中对应的目录，该目录为/var/log/nginx</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>] <span style="color:#75715e"># 初始命令，动态读取指定文件</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到busybox容器中的对应目录，该目录为/logs</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>: <span style="color:#75715e"># 声明volume，name为logs-volume，类型为emptyDir</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">emptyDir</span>: {}
</span></span></code></pre></div><h4 id="hostpath">HostPath</h4>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:100%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-13.png" />
    </div>
    <a href="/image/heima-note-13.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>HostPath将Node主机中的一个实际目录挂载到Pod中，即使Pod销毁，数据依旧可以保存在Node主机上。</p>
<p>同样，如果在此目录中创建文件，容器中也是可以看到的。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-hostpath</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 将logs-volume挂载到nginx容器中对应的目录，该目录为/var/log/nginx</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>: <span style="color:#75715e"># 声明volume，name为logs-volume，类型为hostPath</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/logs</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate</span> <span style="color:#75715e"># 目录存在就使用，不存在就先创建再使用</span>
</span></span></code></pre></div><h4 id="nfs">NFS</h4>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:100%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-14.png" />
    </div>
    <a href="/image/heima-note-14.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>NFS是一个网络文件存储系统，可以搭建一台NFS服务器，然后将Pod连接到NFS上。</p>
<h3 id="pv和pvc">PV和PVC</h3>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:100%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-15.png" />
    </div>
    <a href="/image/heima-note-15.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>PV（Persistent Volume）是对底层的共享存储的一种抽象，可以设置存储空间。PVC（Persistent Volume Claim）是用户对于存储需求的一种声明，即用户向kubernetes系统发出的资源需求申请。</p>
<h4 id="pv">PV</h4>
<p>yaml：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pv2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nfs</span>: <span style="color:#75715e"># 存储类型，和底层正则的存储对应</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#75715e">***</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span>: <span style="color:#75715e">***</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">capacity</span>: <span style="color:#75715e"># 存储能力，目前只支持存储空间的设置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">2Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>: <span style="color:#75715e"># 访问模式</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#75715e">***</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#75715e">***</span> <span style="color:#75715e"># 存储类别</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#75715e">***</span> <span style="color:#75715e"># 回收策略</span>
</span></span></code></pre></div><p>具体来说：</p>
<ul>
<li>
<p>访问模式（accessModes）：描述用户应用对存储资源的访问权限</p>
<ul>
<li>ReadWriteOnce（RWO）：读写权限，但是只能被单个节点挂载。</li>
<li>ReadOnlyMany（ROX）：只读权限，可以被多个节点挂载。</li>
<li>ReadWriteMany（RWX）：读写权限，可以被多个节点挂载。</li>
</ul>
</li>
<li>
<p>回收策略（ persistentVolumeReclaimPolicy）：处理被释放的PV的方式</p>
<ul>
<li>Retain（保留）：保留数据，需要管理员手动清理数据。</li>
</ul>
<ul>
<li>Recycle（回收）：清除PV中的数据，效果相当于<code>rm -rf /volume/*</code>。</li>
<li>Delete（删除）：和PV相连的后端存储完成volume的删除操作，常见于云服务器厂商的存储服务。</li>
</ul>
</li>
<li>
<p>存储类别（storageClassName）：PV可以通过storageClassName参数指定一个存储类别。</p>
<ul>
<li>具有特定类型的PV只能和请求了该类别的PVC进行绑定。</li>
</ul>
<ul>
<li>未设定类别的PV只能和不请求任何类别的PVC进行绑定。</li>
</ul>
</li>
<li>
<p>状态（status）：一个PV的生命周期，可能会处于4种不同的阶段。</p>
<ul>
<li>Available（可用）：表示可用状态，还未被任何PVC绑定。</li>
</ul>
<ul>
<li>Bound（已绑定）：表示PV已经被PVC绑定。</li>
<li>Released（已释放）：表示PVC被删除，但是资源还没有被集群重新释放。</li>
<li>Failed（失败）：表示该PV的自动回收失败。</li>
</ul>
</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">myvolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">normal</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">capacity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">1Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ReadWriteOnce</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hostPath</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/etc/foo</span>
</span></span></code></pre></div><h4 id="pvc">PVC</h4>
<p>yaml：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pvc</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>: <span style="color:#75715e"># 访客模式</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#75715e">***</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e">***</span> <span style="color:#75715e"># 采用标签对PV选择</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#75715e">***</span> <span style="color:#75715e"># 存储类别</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>: <span style="color:#75715e"># 请求空间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">5Gi</span>
</span></span></code></pre></div><p>具体来说：</p>
<ul>
<li>访客模式（accessModes）：用于描述用户应用对存储资源的访问权限，同样包含ReadWriteOnce，ReadOnlyMany和ReadWriteMany。</li>
<li>selector：根据label筛选pv</li>
<li>storageClassName：根据存储类别筛选pv</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">task-pv-claim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">manual</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">ReadWriteOnce</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">3Gi</span>
</span></span></code></pre></div><p>创建一个包含pvc的pod：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;while true;do echo pod1 &gt;&gt; /root/out.txt; sleep 10; done;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/root/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">pvc</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><h3 id="配置存储">配置存储</h3>
<h4 id="configmap">ConfigMap</h4>
<p>yaml：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">info</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">username:admin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">password:123456</span>
</span></span></code></pre></div><p>在pod中引用configMap：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-configmap</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/configmap/config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">configMap</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap</span>
</span></span></code></pre></div><p>可以进入pod查看配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt;&gt; kubectl exec -it pod-configmap -n dev /bin/sh
</span></span><span style="display:flex;"><span>&gt;&gt; cd /configmap/config
</span></span><span style="display:flex;"><span>&gt;&gt; ls
</span></span><span style="display:flex;"><span>&gt;&gt; more info
</span></span></code></pre></div><p>如果更新了configMap，pod中的配置信息也会相应更新。</p>
<h4 id="secret">Secret</h4>
<p>Secret类似于ConfigMap，专门用于保存机密数据。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">Opaque</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">username</span>: <span style="color:#ae81ff">YWRtaW4=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>: <span style="color:#ae81ff">MTIzNDU2</span>
</span></span></code></pre></div><p>在pod中引用secret：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-secret</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/secret/config</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secret</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">secret</span>
</span></span></code></pre></div><h2 id="9-安全认证">9 安全认证</h2>
<h3 id="rbac">RBAC</h3>
<p>RBAC（Role Based Access Control）：基于角色的访问控制，为对象授予权限。</p>


<div class="box">
<figure  itemprop="associatedMedia"
  itemscope itemtype="http://schema.org/ImageObject" 
  style="max-width:100%" >
    <div class="img">
      <img itemprop="thumbnail" src="/image/heima-note-16.png" />
    </div>
    <a href="/image/heima-note-16.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>Role/ClusterRole：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>] <span style="color:#75715e"># 支持的API组列表，&#34;&#34;空字符串，表示核心API群</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;pods&#34;</span>] <span style="color:#75715e"># 支持的资源对象列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>,<span style="color:#e6db74">&#34;watch&#34;</span>,<span style="color:#e6db74">&#34;list&#34;</span>] <span style="color:#75715e"># 对资源对象的操作方法列表</span>
</span></span></code></pre></div><p>参数说明：</p>
<ul>
<li><strong>apiGroups</strong>：&quot;&quot;, &ldquo;apps&rdquo;, &ldquo;autoscaling&rdquo;, &ldquo;batch&rdquo;</li>
<li><strong>resources</strong>：&ldquo;services&rdquo;,&ldquo;endpoints&rdquo;,&ldquo;pods&rdquo;,&ldquo;secrets&rdquo;,&ldquo;configmaps&rdquo;,&ldquo;crontabs&rdquo;,&ldquo;deployments&rdquo;,&ldquo;jobs&rdquo;,&ldquo;nodes&rdquo;,&ldquo;rolebindings&rdquo;,&ldquo;clusterroles&rdquo;,&ldquo;daemonsets&rdquo;,&ldquo;replicasets&rdquo;,&ldquo;statefulsets&rdquo;,&ldquo;horizontalpodautoscalers&rdquo;,&ldquo;replicationcontrollers&rdquo;,&ldquo;cronjobs&rdquo;</li>
<li><strong>verbs</strong>: &ldquo;get&rdquo;, &ldquo;list&rdquo;, &ldquo;watch&rdquo;, &ldquo;create&rdquo;, &ldquo;update&rdquo;, &ldquo;patch&rdquo;, &ldquo;delete&rdquo;, &ldquo;exec&rdquo;</li>
</ul>
<p>RoleBinding/ClusterRoleBinding：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role-binding</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">username</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role</span>
</span></span></code></pre></div>
        </div>

        
        
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">大白猫</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2024-01-22
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>



        
        


        <footer class="post-footer">
          <div class="post-tags">
              <a href="https://zyt153.github.io/tags/k8s/">k8s</a>
                <a href="https://zyt153.github.io/tags/cka/">cka</a>
                <a href="https://zyt153.github.io/tags/study/">study</a>
                
            </div>


          
          <nav class="post-nav">
            
            
              <a class="next" href="/post/golang_get_cert_manager_issuer/">
                <span class="next-text nav-default">golang - 获取cluster中的issuer</span>
                <span class="prev-text nav-mobile">Next</span>
                
                <i class="iconfont">
                  <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

                </i>
              </a>
          </nav>
        </footer>
      </article>

      
      


      
      

  

  
  
    <div class="post">
  <script
    src="https://giscus.app/client.js"
    data-repo="zyt153/zyt153.github.io"
    data-repo-id="R_kgDOKDTjhg"
    data-category="General"
    data-category-id="DIC_kwDOKDTjhs4CZI99"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="en"
    
    crossorigin="anonymous"
    async
  ></script>
</div>

  

  
  

  

  

    

  

  


    </div>

    
    <nav class="toc" id="toc">
    <div class="toc-title">Table of Contents</div>
    <div class="toc-content custom-scrollbar">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#1-k8s介绍">1 k8s介绍</a>
      <ul>
        <li><a href="#k8s组件">k8s组件</a></li>
        <li><a href="#相关概念">相关概念</a></li>
      </ul>
    </li>
    <li><a href="#2-集群搭建">2 集群搭建</a></li>
    <li><a href="#3-资源管理">3 资源管理</a>
      <ul>
        <li><a href="#资源管理介绍">资源管理介绍</a></li>
        <li><a href="#yaml介绍">yaml介绍</a></li>
        <li><a href="#资源管理方式">资源管理方式</a></li>
      </ul>
    </li>
    <li><a href="#4-实战入门">4 实战入门</a>
      <ul>
        <li><a href="#namespace">namespace</a></li>
        <li><a href="#pod">pod</a></li>
        <li><a href="#label">label</a></li>
        <li><a href="#deployment">deployment</a></li>
        <li><a href="#service">service</a></li>
      </ul>
    </li>
    <li><a href="#5-pod详解">5 Pod详解</a>
      <ul>
        <li><a href="#pod结构">pod结构</a></li>
        <li><a href="#podspeccontainers配置">pod.spec.containers配置</a></li>
        <li><a href="#pod生命周期">pod生命周期</a></li>
        <li><a href="#pod调度">pod调度</a></li>
      </ul>
    </li>
    <li><a href="#6-pod控制器">6 Pod控制器</a>
      <ul>
        <li><a href="#replicaset">ReplicaSet</a></li>
        <li><a href="#deployment-1">Deployment</a></li>
        <li><a href="#horizontal-pod-autoscalerhpa">Horizontal Pod Autoscaler（HPA）</a></li>
        <li><a href="#daemonsetds">DaemonSet（DS）</a></li>
        <li><a href="#job">Job</a></li>
        <li><a href="#cronjobcj">CronJob（CJ）</a></li>
      </ul>
    </li>
    <li><a href="#7-service">7 Service</a>
      <ul>
        <li><a href="#service基础">Service基础</a></li>
        <li><a href="#不同类型service示例">不同类型Service示例</a></li>
        <li><a href="#ingress">Ingress</a></li>
      </ul>
    </li>
    <li><a href="#8-数据存储">8 数据存储</a>
      <ul>
        <li><a href="#基本存储">基本存储</a></li>
        <li><a href="#pv和pvc">PV和PVC</a></li>
        <li><a href="#配置存储">配置存储</a></li>
      </ul>
    </li>
    <li><a href="#9-安全认证">9 安全认证</a>
      <ul>
        <li><a href="#rbac">RBAC</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  </nav>


  </div>

      </main>

      <footer id="footer" class="footer">
        <div class="icon-links">
  
  
    <a href="https://github.com/zyt153" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.douban.com/people/167005886/?_i=4097828i6Qoeme" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>
  
    <a href="https://space.bilibili.com/35945316?spm_id_from=333.1007.0.0" rel="me noopener" class="iconfont"
      title="bilibili"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 1024 1024" version="1.1" width="36"
  height="36" id="svg8">
  <path
      style=""
      d="M 744.60599,0.00486267 A 41.779915,41.779915 0 0 0 710.4184,18.673394 L 548.5048,255.32642 h -11.70046 a 41.779915,41.779915 0 0 0 -10.80295,-7.84928 L 235.66,97.084498 a 41.779915,41.779915 0 0 0 -20.07193,-4.960864 41.779915,41.779915 0 0 0 -18.3748,79.145436 L 359.4859,255.32642 H 128.16909 c -49.458302,0 -89.27932,39.82105 -89.27932,89.27932 v 508.65224 c 0,49.4583 39.821018,89.27934 89.27932,89.27934 h 19.48445 C 149.12802,984.5043 179.92773,1024 224.79179,1024 c 44.86407,0 75.66379,-39.4957 77.13826,-81.46268 H 719.98116 C 721.45559,984.5043 752.25533,1024 797.1194,1024 c 44.86406,0 75.6638,-39.4957 77.13824,-81.46268 h 21.57323 c 49.45831,0 89.27936,-39.82104 89.27936,-89.27934 V 344.60574 c 0,-49.45827 -39.82105,-89.27932 -89.27936,-89.27932 H 649.74567 L 779.38103,65.866924 A 41.779915,41.779915 0 0 0 744.60599,0.00486267 Z M 644.49108,418.70871 c 6.29985,0.21538 12.44451,2.01107 17.86888,5.22196 l 171.36218,98.10771 c 18.23417,10.21935 24.63334,33.34627 14.24614,51.48533 -10.38726,18.13909 -33.57344,24.32718 -51.61587,13.77296 L 624.9903,489.18895 c -15.21356,-8.41858 -22.66871,-26.1765 -18.03211,-42.93436 4.63664,-16.75784 20.15573,-28.14465 37.53289,-27.54588 z M 350.2006,432.31846 c 16.89952,0.0317 31.69582,11.33328 36.17844,27.62747 4.48262,16.2942 -2.44981,33.57765 -16.95507,42.24898 l -140.7157,86.91312 c -17.68528,11.18244 -41.09629,5.77692 -52.08912,-12.02686 -10.99282,-17.80373 -5.33855,-41.15658 12.58167,-51.95857 L 329.9002,438.2095 c 6.0643,-3.86439 13.10951,-5.90891 20.3004,-5.89104 z M 501.605,641.53985 c 3.75002,-0.15248 7.48645,0.53903 10.93349,2.0235 0.15842,0.0637 0.31618,0.12888 0.47325,0.19582 0.59328,0.27092 1.17574,0.56489 1.74609,0.88121 0.15868,0.0854 0.31643,0.17233 0.47325,0.2611 0.55694,0.32165 1.10131,0.66458 1.63185,1.02807 0.16455,0.1123 0.32777,0.2265 0.48956,0.34269 0.50382,0.36781 0.99371,0.75428 1.46868,1.15864 0.18724,0.15504 0.37218,0.31282 0.55484,0.47323 0.43271,0.38784 0.8518,0.79061 1.25653,1.20756 0.15449,0.16114 0.30679,0.32437 0.45693,0.48959 0.40798,0.44266 0.79989,0.89988 1.17494,1.37076 0.17799,0.22544 0.35205,0.45395 0.5222,0.68538 0.25932,0.34701 0.50964,0.70071 0.75064,1.06071 0.26712,0.39516 0.52286,0.79784 0.76699,1.20757 0.16907,0.29043 0.33231,0.58424 0.48957,0.88123 0.21836,0.41297 0.42513,0.83199 0.62009,1.25653 0.14836,0.32333 0.28983,0.64976 0.42429,0.97911 0.21319,0.51552 0.40915,1.03801 0.58747,1.5666 0.0677,0.19499 0.13296,0.39085 0.19582,0.58748 0.18652,0.60823 0.34984,1.22334 0.48957,1.84399 0.0397,0.16277 0.0779,0.32601 0.11423,0.48957 0.1436,0.69112 0.25788,1.38801 0.34269,2.08877 0.005,0.0381 0.0111,0.0761 0.0163,0.11424 0.0857,0.78056 0.13474,1.56471 0.14687,2.34988 0.005,0.0543 0.0111,0.10879 0.0163,0.1632 0,0 -0.008,1.12132 0,1.45234 0,0 -0.14697,17.84761 5.89102,34.12231 3.01902,8.13734 7.33278,15.10615 12.61433,19.61501 5.28157,4.50889 11.42894,7.62081 23.64572,7.62081 12.2168,0 18.36416,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.5953,-11.47767 12.6143,-19.61501 6.03799,-16.2747 5.89103,-34.12231 5.89103,-34.12231 -0.44885,-13.87045 10.45922,-25.46302 24.3311,-25.86506 13.87189,-0.40201 25.42828,10.53953 25.78348,24.41272 0,0 1.11929,25.7226 -9.00791,53.01927 -5.06359,13.64832 -13.1986,28.46036 -27.05631,40.29073 -13.85772,11.83039 -33.5454,19.63135 -56.20142,19.63135 -22.65603,0 -42.34371,-7.80096 -56.20141,-19.63135 -4.1801,-3.56856 -7.78733,-7.42433 -10.99878,-11.42303 -3.21235,4.00037 -6.81703,7.85309 -10.99876,11.42303 -13.85773,11.83039 -33.5454,19.63135 -56.20144,19.63135 -22.65601,0 -42.3437,-7.80096 -56.2014,-19.63135 -13.85775,-11.83037 -21.99272,-26.64241 -27.05632,-40.29073 -10.12725,-27.29667 -9.00789,-53.01928 -9.00789,-53.01927 0.20714,-13.83687 11.58744,-24.88848 25.42444,-24.69013 14.1263,0.19991 25.2971,12.0278 24.69011,26.14247 0,0 -0.14697,17.84761 5.89103,34.12231 3.01902,8.13734 7.31646,15.10615 12.598,19.61501 5.28155,4.50889 11.44526,7.62081 23.66203,7.62081 12.21681,0 18.36418,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.57899,-11.47767 12.598,-19.61501 5.76352,-15.53489 5.89112,-32.05691 5.89103,-33.56746 0.006,-0.37466 0.0111,-1.05336 0.0163,-1.20759 -0.0117,-0.74583 0.0105,-1.49177 0.0652,-2.23565 0.009,-0.15784 0.0204,-0.31561 0.0327,-0.47324 0.14204,-1.56859 0.43163,-3.12027 0.86487,-4.63449 0.0213,-0.0763 0.0433,-0.15244 0.0652,-0.22848 3.0335,-10.25748 12.24157,-17.46007 22.92769,-17.93417 z"
      id="rect824"/>
</svg>

    </a>


<a href="https://zyt153.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2023 -
    2024
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        大白猫
        
      </span></span>

  
  

  
</div>

      </footer>

      <div class="button__back-to-top">
        <a href="#back-to-top">
          <i class="iconfont">
            
            <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

          </i>
        </a>
      </div>
    </div>
    
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.2fa20daa982115b9f2c34b25443e21b017260661e7b5017e1bf5e91ae66e1c0a.js" integrity="sha256-L6INqpghFbnyw0slRD4hsBcmBmHntQF&#43;G/XpGuZuHAo=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  

















  </body>
</html>
